esphome:
  name: techroom-esp32
  friendly_name: techroom_esp32
  comment: Heat pump monitoring and optimization node (strict run detection)

esp32:
  board: esp32dev
  framework:
    type: arduino

captive_portal:

logger:

api:
  encryption:
    key: "Fn5q3iQtHADjglb6lmV2/VsNvQwQrF5l1SX9LHsY6bM="

ota:
  - platform: esphome
    password: "3eb91a3a9a10ff28497199e6f94dd233"

safe_mode:
  reboot_timeout: 10min

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Techroom-Esp32 Fallback Hotspot"
    password: "7B1ij5p248v3"

time:
  - platform: homeassistant
    id: ha_time

globals:
  - id: hp_start_counter
    type: int
    restore_value: true
    initial_value: "0"

  - id: hp_last_start_time
    type: uint32_t
    restore_value: false
    initial_value: "0"

  - id: hp_last_run_minutes
    type: float
    restore_value: true
    initial_value: "0.0"

  - id: hp_total_run_minutes
    type: float
    restore_value: true
    initial_value: "0.0"

one_wire:
  - platform: gpio
    pin: GPIO4

sensor:
  # Health
  - platform: wifi_signal
    name: "Heatpump RSSI"
    update_interval: 60s

  - platform: uptime
    name: "Heatpump Uptime"
    update_interval: 60s

  # Virtaus helper (HA)
  - platform: homeassistant
    id: hp_flow_rate
    entity_id: input_number.hp_virtaus
    internal: true

  # Sähköpulssi 400 imp/kWh  --- LISÄTTY internal_filter + clamp ---
  - platform: pulse_counter
    id: hp_pulse_rate
    name: "HP Pulse Rate"
    pin:
      number: GPIO32
      mode: INPUT_PULLUP
    unit_of_measurement: "imp/min"
    accuracy_decimals: 0
    update_interval: 10s
    internal_filter: 13us
    filters:
      - debounce: 13ms
      - lambda: |-
          if (x < 0) return 0;
          if (x > 4000) return 4000;
          return x;


  # P_el [kW] = (imp/min * 60) / 400
  - platform: template
    id: heat_pump_power
    name: "Heat Pump Power"
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 10s
    lambda: |-
      if (id(hp_pulse_rate).state <= 0) return 0;
      return (id(hp_pulse_rate).state * 60.0) / 400.0;

  # Keskiarvotettu P_el -> run-detektiolle
  - platform: template
    id: heat_pump_power_avg
    name: "Heat Pump Power (avg)"
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 10s
    lambda: |-
      return id(heat_pump_power).state;
    filters:
      - exponential_moving_average:
          alpha: 0.2
          send_every: 3

  # Päiväenergia P_el:stä
  - platform: total_daily_energy
    name: "Heat Pump Energy"
    power_id: heat_pump_power
    unit_of_measurement: "kWh"

  # DHT22 (tech room)
  - platform: dht
    pin:
      number: GPIO14
    model: DHT22
    update_interval: 60s
    temperature:
      name: "Tech Room Temperature"
      id: tech_room_temperature
      filters:
        - lambda: |-
            static float last = NAN;
            if (isnan(x)) return last;
            last = x; return x;
    humidity:
      name: "Tech Room Humidity"
      id: tech_room_humidity
      filters:
        - lambda: |-
            static float last = NAN;
            if (isnan(x)) return last;
            last = x; return x;

  # DS18B20 (brine, lataus, varaaja)
  - platform: dallas_temp
    address: 0x813c01b5563b8028
    id: hp_liuos_paluu
    name: "HP liuos paluu"
    filters:
      - filter_out: 85.0
      - filter_out: -127.0
      - median: { window_size: 3, send_every: 1, send_first_at: 1 }

  - platform: dallas_temp
    address: 0x3505473b6c100028
    id: hp_liuos_meno
    name: "HP liuos meno"
    filters:
      - filter_out: 85.0
      - filter_out: -127.0
      - median: { window_size: 3, send_every: 1, send_first_at: 1 }

  - platform: dallas_temp
    address: 0xe005473b310d0028
    id: hp_lataus_meno
    name: "HP lataus meno"
    filters:
      - filter_out: 85.0
      - filter_out: -127.0
      - median: { window_size: 5, send_every: 2, send_first_at: 1 }

  - platform: dallas_temp
    address: 0xbd05473b944b0028
    id: hp_lataus_paluu
    name: "HP lataus paluu"
    filters:
      - filter_out: 85.0
      - filter_out: -127.0
      - median: { window_size: 5, send_every: 2, send_first_at: 1 }

  - platform: dallas_temp
    address: 0xb806473b531a0028
    name: "Varaaja ylä"
    filters:
      - filter_out: 85.0
      - filter_out: -127.0
      - median: { window_size: 5, send_every: 2, send_first_at: 1 }

  - platform: dallas_temp
    address: 0x3c05473b16280028
    name: "Varaaja keski ylä"
    filters:
      - filter_out: 85.0
      - filter_out: -127.0
      - median: { window_size: 5, send_every: 2, send_first_at: 1 }

  - platform: dallas_temp
    address: 0x7006473b1b880028
    name: "Varaaja keski ala"
    filters:
      - filter_out: 85.0
      - filter_out: -127.0
      - median: { window_size: 5, send_every: 2, send_first_at: 1 }

  - platform: dallas_temp
    address: 0x2405473b6e420028
    name: "Varaaja ala"
    filters:
      - filter_out: 85.0
      - filter_out: -127.0
      - median: { window_size: 5, send_every: 2, send_first_at: 1 }

  # UFH kosteat tilat – VAIHDETTU roolit (supply/return)
  - platform: dallas_temp
    address: 0x7105473b43050028
    id: hp_ufh_wet_return
    name: "LL kosteat tilat paluu"
    filters:
      - filter_out: 85.0
      - filter_out: -127.0
      - median: { window_size: 5, send_every: 2, send_first_at: 1 }

  - platform: dallas_temp
    address: 0x0204473b539b0028
    id: hp_ufh_wet_supply
    name: "LL kosteat tilat meno"
    filters:
      - filter_out: 85.0
      - filter_out: -127.0
      - median: { window_size: 5, send_every: 2, send_first_at: 1 }

  # === UUSI: UFH MUUT TILAT (Meno & Paluu) ===
  - platform: dallas_temp
    address: 0x0c00000024109828
    id: ufh_other_supply
    name: "UFH muut tilat meno"
    filters:
      - filter_out: 85.0
      - filter_out: -127.0
      - median: { window_size: 5, send_every: 2, send_first_at: 1 }

  - platform: dallas_temp
    address: 0x2d00000025449728
    id: ufh_other_return
    name: "UFH muut tilat paluu"
    filters:
      - filter_out: 85.0
      - filter_out: -127.0
      - median: { window_size: 5, send_every: 2, send_first_at: 1 }

  # ΔT lataus (näkyy vain käydessä)
  - platform: template
    id: hp_delta_t
    name: "HP Delta T"
    unit_of_measurement: "°C"
    accuracy_decimals: 2
    update_interval: 10s
    lambda: |-
      if (!id(hp_running_filtered).state) return NAN;
      float dt = id(hp_lataus_paluu).state - id(hp_lataus_meno).state;
      if (isnan(dt) || dt <= 0 || dt > 30) return NAN;
      return dt;

  # Brine ΔT: RAW (aina) ja suodatettu (vain käydessä)
  - platform: template
    id: hp_brine_delta_t_raw
    name: "HP Brine Delta T RAW"
    unit_of_measurement: "°C"
    accuracy_decimals: 2
    update_interval: 10s
    lambda: |-
      float meno = id(hp_liuos_meno).state;
      float paluu = id(hp_liuos_paluu).state;
      if (isnan(meno) || isnan(paluu)) return NAN;
      float dt = meno - paluu;
      if (dt < -20 || dt > 30) return NAN;
      return dt;

  - platform: template
    id: hp_brine_delta_t
    name: "HP Brine Delta T"
    unit_of_measurement: "°C"
    accuracy_decimals: 2
    update_interval: 10s
    lambda: |-
      if (!id(hp_running_filtered).state) return NAN;
      float dt = id(hp_brine_delta_t_raw).state;
      if (isnan(dt)) return NAN;
      return dt;

  # Lämpöteho P_th = 1.16 * flow * ΔT
  - platform: template
    id: hp_heat_power
    name: "HP lämpöteho"
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 10s
    lambda: |-
      if (!id(hp_running_filtered).state) return 0;
      float flow = 1.68;
      if (!isnan(id(hp_flow_rate).state) && id(hp_flow_rate).state > 0.1)
        flow = id(hp_flow_rate).state;
      float dt = id(hp_delta_t).state;
      if (isnan(dt) || dt <= 0) return 0;
      return 1.16 * flow * dt;

  # COP
  - platform: template
    name: "Heat Pump COP"
    accuracy_decimals: 2
    update_interval: 30s
    lambda: |-
      if (!id(hp_running_filtered).state) return NAN;
      uint32_t runtime = (millis() - id(hp_last_start_time)) / 1000;
      if (runtime < 180) return NAN;
      float p_el = id(heat_pump_power_avg).state;
      float p_th = id(hp_heat_power).state;
      if (p_el <= 0 || p_th <= 0) return NAN;
      return p_th / p_el;

binary_sensor:
  # Käyntitila
  - platform: template
    id: hp_running_filtered
    name: "Heat Pump Running"
    device_class: running
    lambda: |-
      return id(heat_pump_power_avg).state >= 0.5;
    filters:
      - delayed_on: 120s
      - delayed_off: 180s
    on_press:
      - lambda: |-
          id(hp_start_counter)++;
          id(hp_last_start_time) = millis();
    on_release:
      - lambda: |-
          float minutes = (millis() - id(hp_last_start_time)) / 60000.0;
          id(hp_last_run_minutes) = minutes;
          id(hp_total_run_minutes) += minutes;

  - platform: gpio
    pin:
      number: GPIO27
      mode: INPUT_PULLDOWN
    id: tariff_active
    name: "Tariff Active"

switch:
  - platform: gpio
    pin: GPIO25
    id: relay_1
    restore_mode: ALWAYS_OFF

  - platform: gpio
    pin: GPIO26
    id: relay_2
    restore_mode: ALWAYS_OFF

  - platform: template
    name: "Anturi 2 käytössä"
    lambda: |-
      return id(relay_1).state;
    turn_on_action:
      - if:
          condition:
            binary_sensor.is_off: hp_running_filtered
          then:
            - delay: 500ms
            - switch.turn_on: relay_1
            - switch.turn_on: relay_2
    turn_off_action:
      - if:
          condition:
            binary_sensor.is_off: hp_running_filtered
          then:
            - delay: 500ms
            - switch.turn_off: relay_1
            - switch.turn_off: relay_2

interval:
  - interval: 10s
    then:
      - lambda: |-
          ESP_LOGI("brine",
            "Brine meno=%.2f C, paluu=%.2f C, RAW dT=%.2f C, Running=%s",
            id(hp_liuos_meno).state,
            id(hp_liuos_paluu).state,
            id(hp_brine_delta_t_raw).state,
            id(hp_running_filtered).state ? "ON" : "OFF");
