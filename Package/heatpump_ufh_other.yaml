# packages/heatpump_ufh_other.yaml
# UFH "Muut tilat" (v2) – suora sidonta techroom_esp32_* lähteisiin,
# numeric-only + trigger, ohittaa restored/unavailable.

template:
  - trigger:
      - platform: homeassistant
        event: start
      - platform: time_pattern
        minutes: "/2"
      - platform: state
        entity_id:
          - sensor.techroom_esp32_ufh_muut_tilat_meno
          - sensor.techroom_esp32_ufh_muut_tilat_paluu
          - input_number.hp_ufh_main_flow
    sensor:
      - name: "Heatpump UFH Main Supply v2"
        unique_id: heatpump_ufh_main_supply_v2
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        state: "{{ states('sensor.techroom_esp32_ufh_muut_tilat_meno')|float(0) }}"
        availability: >
          {{ states('sensor.techroom_esp32_ufh_muut_tilat_meno') not in ['unknown','unavailable','','None', none]
             and (state_attr('sensor.techroom_esp32_ufh_muut_tilat_meno','restored') != true) }}

      - name: "Heatpump UFH Main Return v2"
        unique_id: heatpump_ufh_main_return_v2
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        state: "{{ states('sensor.techroom_esp32_ufh_muut_tilat_paluu')|float(0) }}"
        availability: >
          {{ states('sensor.techroom_esp32_ufh_muut_tilat_paluu') not in ['unknown','unavailable','','None', none]
             and (state_attr('sensor.techroom_esp32_ufh_muut_tilat_paluu','restored') != true) }}

      - name: "Heatpump UFH Main Delta T v2"
        unique_id: heatpump_ufh_main_delta_t_v2
        unit_of_measurement: "°C"
        device_class: temperature
        icon: mdi:delta
        state_class: measurement
        state: >
          {% set s = states('sensor.heatpump_ufh_main_supply_v2')|float(0) %}
          {% set r = states('sensor.heatpump_ufh_main_return_v2')|float(0) %}
          {{ (s - r)|round(2) }}
        availability: >
          {{ states('sensor.heatpump_ufh_main_supply_v2') not in ['unknown','unavailable','','None', none]
             and states('sensor.heatpump_ufh_main_return_v2') not in ['unknown','unavailable','','None', none] }}

      - name: "Heatpump UFH Main Heat Power v2"
        unique_id: heatpump_ufh_main_heat_power_v2
        unit_of_measurement: "kW"
        device_class: power
        state_class: measurement
        state: >
          {% set q  = states('input_number.hp_ufh_main_flow')|float(0) %}
          {% set dt = states('sensor.heatpump_ufh_main_delta_t_v2')|float(0) %}
          {{ (1.1611 * q * (dt if dt>0 else 0))|round(2) }}
        availability: >
          {{ states('sensor.heatpump_ufh_main_delta_t_v2') not in ['unknown','unavailable','','None', none]
             and (states('input_number.hp_ufh_main_flow')|float(0) > 0) }}