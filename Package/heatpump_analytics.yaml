# SCOPit ja muut kokooma-analyysit

template:
  - sensor:
      - name: "Heatpump SCOP (instant)"
        unique_id: heatpump_scop_instant
        unit_of_measurement: ""
        state_class: measurement
        icon: mdi:ratio
        state: >
          {% set pth = states('sensor.heatpump_heat_power')|float(0) %}
          {% set pel = states('sensor.heatpump_power_display')|float(0) %}
          {{ (pth / pel)|round(2) if pth>0 and pel>0 else 0 }}

      - name: "Heatpump SCOP (daily)"
        unique_id: heatpump_scop_daily
        unit_of_measurement: ""
        icon: mdi:calendar-today
        state_class: measurement
        state: >
          {% set Q = states('sensor.heatpump_heat_daily')|float(0) %}
          {% set E = states('sensor.heatpump_electricity_daily')|float(0) %}
          {{ (Q/E)|round(2) if Q>0 and E>0 else 0 }}

      - name: "Heatpump SCOP (monthly)"
        unique_id: heatpump_scop_monthly
        unit_of_measurement: ""
        icon: mdi:calendar-month
        state_class: measurement
        state: >
          {% set Q = states('sensor.heatpump_heat_monthly')|float(0) %}
          {% set E = states('sensor.heatpump_electricity_monthly')|float(0) %}
          {{ (Q/E)|round(2) if Q>0 and E>0 else 0 }}

  - sensor:
      - name: "Heatpump Brine Power"
        unique_id: heatpump_brine_power
        unit_of_measurement: "kW"
        device_class: power
        state_class: measurement
        icon: mdi:snowflake-thermometer
        state: >
          {% set meno  = states('sensor.techroom_esp32_hp_liuos_meno') %}
          {% set paluu = states('sensor.techroom_esp32_hp_liuos_paluu') %}
          {% set flow  = states('input_number.hp_virtaus')|float(0) %}
          {% if meno not in ['unknown','unavailable','', none] and paluu not in ['unknown','unavailable','', none] and flow>0 %}
            {% set dt = (meno|float - paluu|float) %}
            {{ (1.16 * flow * (dt if dt>0 else 0))|round(2) }}
          {% else %} 0 {% endif %}
