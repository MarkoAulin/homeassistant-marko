# packages/heatpump_ufh.yaml
# UFH – märkätilat (v2) + TOTAL (v2); robusti availability + trigger

input_number:
  hp_kosteat_virtaus:
    name: "LL kosteat tilat virtaus"
    min: 0.00
    max: 1.50
    step: 0.01
    unit_of_measurement: "m³/h"
    mode: box
    icon: mdi:water
    initial: 0.20

  hp_ufh_main_flow:
    name: "LL muut tilat virtaus"
    min: 0.00
    max: 2.50
    step: 0.01
    unit_of_measurement: "m³/h"
    mode: box
    icon: mdi:water
    initial: 0.80

template:
  - trigger:
      - platform: homeassistant
        event: start
      - platform: time_pattern
        minutes: "/2"
      - platform: state
        entity_id:
          - sensor.techroom_esp32_ll_kosteat_tilat_meno
          - sensor.techroom_esp32_ll_kosteat_tilat_paluu
          - input_number.hp_kosteat_virtaus
          - input_number.hp_ufh_main_flow
          - sensor.heatpump_ufh_main_heat_power_v2
    sensor:
      # ---------- Märkätilat (v2) ----------
      - name: "Heatpump UFH Wet Supply v2"
        unique_id: heatpump_ufh_wet_supply_v2_unique
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        state: "{{ states('sensor.techroom_esp32_ll_kosteat_tilat_meno')|float(0) }}"
        availability: >-
          {{ states('sensor.techroom_esp32_ll_kosteat_tilat_meno') not in ['unknown','unavailable','','None', none] }}

      - name: "Heatpump UFH Wet Return v2"
        unique_id: heatpump_ufh_wet_return_v2_unique
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        state: "{{ states('sensor.techroom_esp32_ll_kosteat_tilat_paluu')|float(0) }}"
        availability: >-
          {{ states('sensor.techroom_esp32_ll_kosteat_tilat_paluu') not in ['unknown','unavailable','','None', none] }}

      - name: "Heatpump UFH Wet Delta T v2"
        unique_id: heatpump_ufh_wet_delta_t_v2_unique
        unit_of_measurement: "°C"
        device_class: temperature
        icon: mdi:delta
        state_class: measurement
        state: >-
          {% set s = states('sensor.heatpump_ufh_wet_supply_v2')|float(0) %}
          {% set r = states('sensor.heatpump_ufh_wet_return_v2')|float(0) %}
          {{ (s - r)|round(2) }}
        availability: >-
          {{ states('sensor.heatpump_ufh_wet_supply_v2') not in ['unknown','unavailable','','None', none]
             and states('sensor.heatpump_ufh_wet_return_v2') not in ['unknown','unavailable','','None', none] }}

      - name: "Heatpump UFH Wet Heat Power v2"
        unique_id: heatpump_ufh_wet_heat_power_v2_unique
        unit_of_measurement: "kW"
        device_class: power
        state_class: measurement
        state: >-
          {% set flow = states('input_number.hp_kosteat_virtaus')|float(0) %}
          {% set dt = states('sensor.heatpump_ufh_wet_delta_t_v2')|float(0) %}
          {{ (1.1611 * flow * (dt if dt>0 else 0))|round(2) }}
        availability: >-
          {{ states('sensor.heatpump_ufh_wet_delta_t_v2') not in ['unknown','unavailable','','None', none]
             and (states('input_number.hp_kosteat_virtaus')|float(0) > 0) }}

      # ---------- TOTAL (v2) = märkätilat + muut tilat ----------
      - name: "Heatpump UFH Total Heat Power v2"
        unique_id: heatpump_ufh_total_heat_power_v2_unique
        unit_of_measurement: "kW"
        device_class: power
        state_class: measurement
        state: >-
          {% set wet  = states('sensor.heatpump_ufh_wet_heat_power_v2')|float(0) %}
          {% set main = states('sensor.heatpump_ufh_main_heat_power_v2')|float(0) %}
          {{ (wet + main)|round(2) }}
        availability: >-
          {{ states('sensor.heatpump_ufh_wet_heat_power_v2') not in ['unknown','unavailable','','None', none]
             or  states('sensor.heatpump_ufh_main_heat_power_v2') not in ['unknown','unavailable','','None', none] }}