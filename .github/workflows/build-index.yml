name: Build INDEX.md

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.yaml'
      - '**/*.yml'
      - '**/*.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Generate INDEX.md
        shell: bash
        env:
          REPO: ${{ github.repository }}           # esim. MarkoAulin/homeassistant-marko
          BRANCH: ${{ github.ref_name }}           # esim. main
        run: |
          set -euo pipefail

          # 1) Valitse, mitä kansioita indeksoidaan (voit muokata)
          INCLUDE_DIRS=("Dashboard" "Package" "ESPHome")
          # Halutessasi näytetään myös juuren tietyt tiedostot:
          ROOT_FILES=("configuration.yaml" "README.md")

          echo "# INDEX" > INDEX.md
          echo "" >> INDEX.md
          echo "_Auto-generated by GitHub Actions – $(date -u +"%Y-%m-%d %H:%M:%SZ") (UTC)_" >> INDEX.md
          echo "" >> INDEX.md

          # 2) Funktio: listaa kansion tiedostot ja tuottaa raw-linkit
          gen_section () {
            local DIR="$1"
            local TITLE="$2"
            if [ -d "$DIR" ]; then
              echo "## ${TITLE}" >> INDEX.md
              echo "" >> INDEX.md
              # Järjestetään tiedostot aakkosittain, vain tiedostot (ei .git tms.)
              while IFS= read -r -d '' f; do
                # Muodosta polku suhteessa repojuureen
                REL="${f#./}"
                RAW="https://raw.githubusercontent.com/${REPO}/${BRANCH}/${REL}"
                echo "- \`${REL}\`" >> INDEX.md
                echo "  " >> INDEX.md
                echo "  ${RAW}" >> INDEX.md
                echo "" >> INDEX.md
              done < <(find "./${DIR}" -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.md" \) -print0 | sort -z)
              echo "" >> INDEX.md
            fi
          }

          # 3) Luo osiot
          for d in "${INCLUDE_DIRS[@]}"; do
            gen_section "$d" "$d files"
          done

          # 4) Juuren valitut tiedostot
          echo "## Root files" >> INDEX.md
          echo "" >> INDEX.md
          for rf in "${ROOT_FILES[@]}"; do
            if [ -f "$rf" ]; then
              RAW="https://raw.githubusercontent.com/${REPO}/${BRANCH}/${rf}"
              echo "- \`${rf}\`" >> INDEX.md
              echo "  " >> INDEX.md
              echo "  ${RAW}" >> INDEX.md
              echo "" >> INDEX.md
            fi
          done

          # 5) (Valinnainen) Luo hakemisto diagnostiikkaa varten, jos sitä ei ole
          mkdir -p diagnostics

      - name: Commit & push INDEX.md if changed
        shell: bash
        run: |
          set -euo pipefail
          if ! git diff --quiet INDEX.md; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add INDEX.md
            git commit -m "chore: auto-update INDEX.md"
            git push
          else
            echo "No changes in INDEX.md"
          fi
