name: Build INDEX.md

on:
  # Aja automaattisesti, kun näissä hakemistoissa muuttuu tiedostoja
  push:
    branches: [ main ]
    paths:
      - 'Dashboard/**'
      - 'Package/**'
      - 'ESPHome/**'
      - 'configuration.yaml'
      - 'README.md'
      - '.github/workflows/build-index.yml'
  # Aja myös käsin Actions-sivulta
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-index:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Generate INDEX.md
        shell: bash
        env:
          REPO: ${{ github.repository }}   # esim. MarkoAulin/homeassistant-marko
          BRANCH: ${{ github.ref_name }}   # esim. main
        run: |
          set -euo pipefail

          # 0) Valittavat hakemistot (EDITOI VAPAASTI)
          INCLUDE_DIRS=("Dashboard" "Package" "ESPHome")
          # Juuren tiedostot, jotka halutaan listata
          ROOT_FILES=("configuration.yaml" "README.md")

          # 1) Aloita puhtaalta pöydältä
          rm -f INDEX.md
          echo "# INDEX"                           >> INDEX.md
          echo                                      >> INDEX.md
          echo "_Auto-generated $(date -u +"%Y-%m-%d %H:%M:%SZ") (UTC)_" >> INDEX.md
          echo                                      >> INDEX.md

          # 2) Apufunktio: listaa yhden hakemiston tiedostot (yaml/yml/md)
          gen_section () {
            local DIR="$1"
            local TITLE="$2"
            if [ -d "$DIR" ]; then
              echo "## ${TITLE}" >> INDEX.md
              echo               >> INDEX.md

              # Etsi tiedostot, lajittelu aakkosittain, välilyönnit kestävästi
              while IFS= read -r -d '' f; do
                REL="${f#./}"   # poista ./-prefiksi
                RAW="https://raw.githubusercontent.com/${REPO}/${BRANCH}/${REL}"
                echo "- \`${REL}\`"      >> INDEX.md
                echo "  "                >> INDEX.md
                echo "  ${RAW}"          >> INDEX.md
                echo                     >> INDEX.md
              done < <(find "./${DIR}" -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.md" \) -print0 | sort -z)

              echo >> INDEX.md
            else
              # Kirjaa otsikko silti, jotta näkee ettei kansio puutu vahingossa
              echo "## ${TITLE}" >> INDEX.md
              echo               >> INDEX.md
              echo "_(directory \`${DIR}\` not found)_" >> INDEX.md
              echo               >> INDEX.md
            fi
          }

          # 3) Luo osiot valituista hakemistoista
          for d in "${INCLUDE_DIRS[@]}"; do
            gen_section "$d" "$d files"
          done

          # 4) Juuren valitut tiedostot
          echo "## Root files"  >> INDEX.md
          echo                  >> INDEX.md
          for rf in "${ROOT_FILES[@]}"; do
            if [ -f "$rf" ]; then
              RAW="https://raw.githubusercontent.com/${REPO}/${BRANCH}/${rf}"
              echo "- \`${rf}\`" >> INDEX.md
              echo "  "          >> INDEX.md
              echo "  ${RAW}"    >> INDEX.md
              echo               >> INDEX.md
            fi
          done

          # 5) (Valinnainen) Luo diagnostinen hakemisto jos puuttuu
          mkdir -p diagnostics

      - name: Commit & push INDEX.md if changed
        shell: bash
        run: |
          set -euo pipefail
          # Onko muuttunut tähän commit-työtilaan verrattuna?
          if ! git diff --quiet INDEX.md; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add INDEX.md
            git commit -m "chore: auto-update INDEX.md"
            git push
            echo "INDEX.md updated & pushed."
          else
            echo "No changes in INDEX.md."
          fi
